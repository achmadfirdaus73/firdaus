<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi E-Commerce Kolektor</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.css">
    <link rel="stylesheet" type="text/css" charset="UTF-8" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.6.0/slick.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.6.0/slick-theme.min.css" />

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-slick/0.29.0/react-slick.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.5.0/semantic.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

    <style>
        body { background-color: #f0f2f5; }
        .mobile-content-padding { padding-bottom: 60px !important; }
        .slick-prev:before, .slick-next:before { color: black !important; }
        .promo-carousel img { border-radius: 8px; }
        .tenor-buttons-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .thumbnail-gallery { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .thumbnail { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; cursor: pointer; border: 2px solid transparent; transition: border-color 0.2s; }
        .thumbnail:hover { border-color: #ddd; }
        .active-thumbnail { border-color: #00B5AD; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        //================================= HOOKS & UTILITIES =================================
        function useWindowSize() {
            const [size, setSize] = useState({width: window.innerWidth, height: window.innerHeight});
            useEffect(() => {
                function handleResize(){
                    setSize({width: window.innerWidth, height: window.innerHeight});
                }
                window.addEventListener("resize", handleResize);
                return () => window.removeEventListener("resize", handleResize);
            }, []);
            return size;
        }

        //================================= KOMPONEN-KOMPONEN =================================
        function LoginPage({ onLogin, onRegister }) {
            const [isRegister, setIsRegister] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (isRegister) {
                    if (password !== confirmPassword) {
                        alert('Password tidak cocok!');
                        return;
                    }
                    onRegister(email, password);
                } else {
                    onLogin(email, password);
                }
            };

            return (
                <div className="ui middle aligned center aligned grid" style={{ height: '100vh' }}>
                    <div className="column" style={{ maxWidth: 450 }}>
                        <h2 className="ui teal image header">
                            <i className="shipping fast icon"></i>
                            <div className="content">
                                {isRegister ? 'Daftar Akun Baru' : 'Login ke Sistem'}
                            </div>
                        </h2>
                        <form className="ui large form" onSubmit={handleSubmit}>
                            <div className="ui stacked segment">
                                <div className="field">
                                    <div className="ui left icon input">
                                        <i className="user icon"></i>
                                        <input type="email" name="email" placeholder="Alamat E-mail" value={email} onChange={(e) => setEmail(e.target.value)} required />
                                    </div>
                                </div>
                                <div className="field">
                                    <div className="ui left icon input">
                                        <i className="lock icon"></i>
                                        <input type="password" name="password" placeholder="Password" value={password} onChange={(e) => setPassword(e.target.value)} required />
                                    </div>
                                </div>
                                {isRegister && (
                                    <div className="field">
                                        <div className="ui left icon input">
                                            <i className="lock icon"></i>
                                            <input type="password" name="confirmPassword" placeholder="Konfirmasi Password" value={confirmPassword} onChange={(e) => setConfirmPassword(e.target.value)} required />
                                        </div>
                                    </div>
                                )}
                                <button className="ui fluid large teal submit button" type="submit">
                                    {isRegister ? 'Daftar' : 'Login'}
                                </button>
                            </div>
                        </form>
                        <div className="ui message">
                            {isRegister ? 'Sudah punya akun? ' : 'Belum punya akun? '}
                            <a href="#" onClick={(e) => { e.preventDefault(); setIsRegister(!isRegister); }}>
                                {isRegister ? 'Login di sini' : 'Daftar sekarang'}
                            </a>
                        </div>
                    </div>
                </div>
            );
        }

        function ProfileForm({ onSave, user }) {
            const [data, setData] = useState({
                namaLengkap: user.namaLengkap || user.email || '', // Mengambil dari user.namaLengkap jika ada
                jenisUsaha: user.jenisUsaha || '',
                alamatRumah: user.alamatRumah || '',
                alamatUsaha: user.alamatUsaha || '',
                noHape: user.noHape || '',
                nomorKtp: user.nomorKtp || '',
                namaSales: user.namaSales || ''
            });

            const handleChange = (e) => {
                const { name, value } = e.target;
                setData(prevData => ({ ...prevData, [name]: value }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                for (const key in data) {
                    if (key !== 'namaSales' && data[key].trim() === '') {
                        alert(`Kolom "${key}" harus diisi.`);
                        return;
                    }
                }
                onSave(data);
            };

            return (
                <div className="ui container" style={{marginTop:'2em'}}>
                    <div className="ui segment">
                        <h2 className="ui dividing header">Lengkapi Profil</h2>
                        <form className="ui form" onSubmit={handleSubmit}>
                            <div className="two fields">
                                <div className="field"><label>Nama Lengkap</label><input type="text" name="namaLengkap" value={data.namaLengkap} onChange={handleChange}/></div>
                                <div className="field"><label>Jenis Usaha</label><input type="text" name="jenisUsaha" value={data.jenisUsaha} onChange={handleChange}/></div>
                            </div>
                            <div className="field"><label>Alamat Rumah</label><textarea rows="2" name="alamatRumah" value={data.alamatRumah} onChange={handleChange}></textarea></div>
                            <div className="field"><label>Alamat Usaha</label><textarea rows="2" name="alamatUsaha" value={data.alamatUsaha} onChange={handleChange}></textarea></div>
                            <div className="three fields">
                                <div className="field"><label>No. HP</label><input type="text" name="noHape" value={data.noHape} onChange={handleChange}/></div>
                                <div className="field"><label>No. KTP</label><input type="text" name="nomorKtp" value={data.nomorKtp} onChange={handleChange}/></div>
                                <div className="field"><label>Nama Sales</label><input type="text" name="namaSales" value={data.namaSales} onChange={handleChange}/></div>
                            </div>
                            <button className="ui primary button" type="submit">Simpan</button>
                        </form>
                    </div>
                </div>
            );
        }

        function AdminDashboard({ user, onLogout, onAddProduct, products, onAddPromo, promos, orders, onUpdateOrderStatus, collectors, onAssignCollector, consumers }) {
            const [activeItem, setActiveItem] = useState('order');
            const [viewingBill, setViewingBill] = useState(null);
            const [newProduct, setNewProduct] = useState({ name: '', description: '', hargaModal: '', images: '' });
            const [newPromoUrl, setNewPromoUrl] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const size = useWindowSize();
            const isMobile = size.width < 768;

            useEffect(() => {
                if (viewingBill && $('.ui.progress').length) {
                    setTimeout(() => $('.ui.progress').progress(), 50);
                }
            }, [viewingBill]);

            function AssignCollectorDropdown({ order, collectors, onAssignCollector }) {
                const [selectedCollectorUid, setSelectedCollectorUid] = useState('');
                const [selectedCollectorName, setSelectedCollectorName] = useState('');

                // Set initial values if collector is already assigned
                useEffect(() => {
                    if (order.assignedCollectorUid && collectors.length > 0) {
                        const assignedCol = collectors.find(c => c.uid === order.assignedCollectorUid);
                        if (assignedCol) {
                            setSelectedCollectorUid(assignedCol.uid);
                            setSelectedCollectorName(assignedCol.name);
                        }
                    } else {
                        setSelectedCollectorUid('');
                        setSelectedCollectorName('');
                    }
                }, [order.assignedCollectorUid, collectors]);

                if (order.assignedCollector) { return <span><i className="user check icon"></i>{order.assignedCollector}</span>; }
                
                return (
                    <div style={{ display: 'flex', gap: '10px', alignItems: 'center' }}>
                        <select 
                            className="ui mini dropdown" 
                            value={selectedCollectorUid} 
                            onChange={(e) => {
                                const uid = e.target.value;
                                const selectedCol = collectors.find(c => c.uid === uid);
                                setSelectedCollectorUid(uid);
                                setSelectedCollectorName(selectedCol ? selectedCol.name : '');
                            }}
                        >
                            <option value="">Pilih</option>
                            {collectors && collectors.map(c => <option key={c.uid} value={c.uid}>{c.name}</option>)}
                        </select>
                        <button 
                            className="ui mini positive button" 
                            onClick={() => onAssignCollector(order.id, selectedCollectorName, selectedCollectorUid)} 
                            disabled={!selectedCollectorUid}
                        >
                            Tugas
                        </button>
                    </div>
                );
            }

            const handleProductSubmit = (e) => { e.preventDefault(); if (!newProduct.name || !newProduct.hargaModal || !newProduct.images) return alert('Data produk tidak lengkap'); const p = { id: Date.now(), ...newProduct, hargaModal: parseInt(newProduct.hargaModal), images: newProduct.images.split(',') }; onAddProduct(p); setNewProduct({ name: '', description: '', hargaModal: '', images: '' }); alert('Produk ditambahkan!'); };
            const handlePromoSubmit = (e) => { e.preventDefault(); if (!newPromoUrl.trim()) return alert('URL Promo kosong'); onAddPromo({ id: Date.now(), imageUrl: newPromoUrl.trim() }); setNewPromoUrl(''); alert('Promo ditambahkan!'); };
            const renderStatusLabel = (status) => { const s = { 'Proses': 'yellow', 'Pengiriman': 'blue', 'Terkirim': 'green', 'Lunas': 'grey' }; return <span className={`ui ${s[status] || ''} label`}>{status}</span>; };
            
            const menuItems = [ { name: 'order', text: 'Order', icon: 'inbox' }, { name: 'produk', text: 'Produk & Promo', icon: 'box' }, { name: 'tagihan', text: 'Tagihan', icon: 'file invoice dollar' }, { name: 'data_konsumen', text: 'Data Konsumen', icon: 'users' } ];

            const renderContent = () => {
                switch (activeItem) {
                    case 'order':
                        return (
                            <div>
                                <h3 className="ui dividing header">Manajemen Pesanan</h3>
                                <div className="ui relaxed divided list">
                                    {orders && orders.map(order => { {/* Changed 'order' to 'orders' */}
                                        const consumerProfile = consumers && consumers.find(c => c.email === order.consumerEmail);
                                        const salesName = consumerProfile ? consumerProfile.namaSales : 'N/A';
                                        return (
                                            <div className="item" key={order.id}>
                                                <div className="right floated content" style={{display: 'flex', alignItems: 'center'}}>
                                                    {order.status === 'Proses' && <button className="ui small blue button" onClick={() => onUpdateOrderStatus(order.id, 'Pengiriman')}>Kirim</button>}
                                                    {order.status === 'Pengiriman' && <button className="ui small teal button" onClick={() => onUpdateOrderStatus(order.id, 'Terkirim')}>Terkirim</button>}
                                                    {order.status === 'Terkirim' && <AssignCollectorDropdown order={order} collectors={collectors} onAssignCollector={onAssignCollector} />}
                                                </div>
                                                <div className="content">
                                                    <div className="header">{order.productName} ({order.id})</div>
                                                    <div className="description">
                                                        Pemesan: <strong>{consumerProfile ? consumerProfile.namaLengkap : order.consumerName}</strong> | Tenor: <strong>{order.tenor} hari</strong> | Sales: <strong>{salesName}</strong>
                                                        <br/>
                                                        Angsuran: <strong>Rp {order.installmentPrice.toLocaleString('id-ID')} / {order.paymentFrequency === 'mingguan' ? 'minggu' : 'hari'}</strong>
                                                    </div>
                                                    <div className="extra" style={{marginTop: '5px'}}>
                                                        {order.date} - {renderStatusLabel(order.status)}
                                                    </div>
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        );
                    case 'produk':
                        return (
                            <div>
                                <h3 className="ui dividing header">Produk & Promo</h3>
                                <form className="ui form" onSubmit={handleProductSubmit}>
                                    <div className="field"><label>Nama Barang</label><input type="text" name="name" value={newProduct.name} onChange={(e) => setNewProduct(p=>({...p, name: e.target.value}))} /></div>
                                    <div className="field"><label>Deskripsi</label><textarea rows="2" name="description" value={newProduct.description} onChange={(e) => setNewProduct(p=>({...p, description: e.target.value}))}></textarea></div>
                                    <div className="field"><label>Harga Modal</label><input type="number" name="hargaModal" value={newProduct.hargaModal} onChange={(e) => setNewProduct(p=>({...p, hargaModal: e.target.value}))} /></div>
                                    <div className="field"><label>Foto (Pisahkan URL dgn koma)</label><textarea rows="2" name="images" value={newProduct.images} onChange={(e) => setNewProduct(p=>({...p, images: e.target.value}))}></textarea></div>
                                    <button className="ui primary button" type="submit">Tambah Produk</button>
                                </form>
                                <h3 className="ui dividing header" style={{marginTop: '2em'}}>Tambah Promo</h3>
                                <form className="ui form" onSubmit={handlePromoSubmit}>
                                    <div className="field"><label>URL Gambar Promo</label><input type="text" value={newPromoUrl} onChange={(e) => setNewPromoUrl(e.target.value)} /></div>
                                    <button className="ui teal button" type="submit">Tambah Promo</button>
                                </form>
                            </div>
                        );
                    case 'tagihan':
                        const activeBills = orders && orders.filter(o => o.status === 'Terkirim');
                        const filteredBills = activeBills && activeBills.filter(bill =>
                            bill.productName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            bill.consumerName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            (bill.assignedCollector && bill.assignedCollector.toLowerCase().includes(searchTerm.toLowerCase()))
                        );
                        return (
                            <div>
                                <h3 className="ui dividing header">Semua Tagihan Berjalan</h3>
                                <div className="ui fluid icon input" style={{marginBottom: '1em'}}>
                                    <input type="text" placeholder="Cari..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /><i className="search icon"></i>
                                </div>
                                {filteredBills && filteredBills.length === 0 ? <p>Tidak ada tagihan aktif.</p> : (
                                    <div className="ui selection relaxed divided list">
                                        {filteredBills && filteredBills.map(bill => (
                                            <div className="item" key={bill.id} onClick={() => setViewingBill(bill)} style={{cursor: 'pointer'}}>
                                                <div className="right floated content"><i className="chevron right icon"></i></div>
                                                <div className="content">
                                                    <div className="header">{bill.productName} ({bill.id})</div>
                                                    <div className="description">Konsumen: {bill.consumerName} | Penagih: {bill.assignedCollector || 'Belum ditugaskan'}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        );
                    case 'data_konsumen':
                        return (
                            <div>
                                <h3 className="ui dividing header">Data Konsumen</h3>
                                {consumers && consumers.length === 0 ? <p>Belum ada data konsumen.</p> : (
                                    <table className="ui celled table">
                                        <thead><tr><th>Nama</th><th>Usaha</th><th>No. HP</th><th>Alamat Usaha</th><th>No. KTP</th><th>Status Tagihan</th></tr></thead>
                                        <tbody>
                                            {consumers && consumers.map(c => {
                                                const hasActiveBill = orders && orders.some(o =>
                                                    o.consumerEmail === c.email &&
                                                    o.status !== 'Lunas'
                                                );
                                                return (
                                                    <tr key={c.uid}>
                                                        <td>{c.namaLengkap || c.email}</td>
                                                        <td>{c.jenisUsaha}</td>
                                                        <td>{c.noHape}</td>
                                                        <td>{c.alamatUsaha}</td>
                                                        <td>{c.nomorKtp}</td>
                                                        <td>{hasActiveBill ? <span className="ui yellow label"><i className="sync alternate icon"></i>Berjalan</span> : <span className="ui green label"><i className="check circle icon"></i>Lunas</span>}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                )}
                            </div>
                        );
                    default: return null;
                }
            };

            const Layout = ({children}) => (
                <div>
                    <div className="ui top attached menu">
                        <div className="item"><i className="cogs big icon"></i><b>Admin Dashboard</b></div>
                        <div className="right menu">
                            <div className="item">
                                <button className="ui red button mini" onClick={onLogout}>
                                    <i className="sign out icon"></i> Logout
                                </button>
                            </div>
                        </div>
                    </div>
                    {children}
                </div>
            );

            return (
                <React.Fragment>
                    <Layout>
                        {isMobile ? (
                            <div className="ui attached segment mobile-content-padding">{renderContent()}</div>
                        ) : (
                            <div className="ui attached segment">
                                <div className="ui grid">
                                    <div className="four wide column">
                                        <div className="ui vertical fluid pointing menu">
                                            {menuItems.map(item => (
                                                <a key={item.name} className={activeItem === item.name ? 'active teal item' : 'item'} onClick={() => setActiveItem(item.name)}>
                                                    <i className={`${item.icon} icon`}></i> {item.text}
                                                </a>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="twelve wide stretched column">
                                        <div className="ui segment">{renderContent()}</div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </Layout>
                    
                    {isMobile && (
                        <div className="ui bottom fixed four item icon menu">
                            {menuItems.map(item => (<a key={item.name} className={activeItem === item.name ? 'active teal item' : 'item'} onClick={() => setActiveItem(item.name)}><i className={`${item.icon} icon`}></i><span style={{fontSize:'0.8em'}}>{item.text}</span></a>))}
                        </div>
                    )}

                    {viewingBill && (
                        <div className={`ui dimmer modals page transition visible active`} style={{display: 'flex !important', zIndex: 1001}}>
                            <div className={`ui standard modal transition visible active`}>
                                <i className="close icon" onClick={() => setViewingBill(null)}></i>
                                <div className="header">Detail Tagihan: {viewingBill.productName} ({viewingBill.id})</div>
                                <div className="content">
                                    <p><strong>Konsumen:</strong> {viewingBill.consumerName}</p>
                                    <p><strong>Penagih:</strong> {viewingBill.assignedCollector || 'Belum ada'}</p>
                                    <p><strong>Angsuran:</strong> Rp {viewingBill.installmentPrice.toLocaleString('id-ID')} / {viewingBill.paymentFrequency === 'mingguan' ? 'minggu' : 'hari'}</p>
                                    <div className="ui teal progress" data-value={viewingBill.payments.length} data-total={viewingBill.tenor}>
                                        <div className="bar"><div className="progress"></div></div>
                                        <div className="label">Terbayar {viewingBill.payments.length} dari {viewingBill.tenor} hari</div>
                                    </div>
                                    <h4 className="ui dividing header">Riwayat Pembayaran</h4>
                                    {viewingBill.payments && viewingBill.payments.length === 0 ? <p>Belum ada pembayaran.</p> : (
                                        <div style={{maxHeight: '200px', overflowY: 'auto'}}>
                                            <table className="ui celled table">
                                                <thead><tr><th>Pembayaran Ke-</th><th>Tanggal</th></tr></thead>
                                                <tbody>
                                                    {viewingBill.payments && viewingBill.payments.map((payment, index) => (
                                                        <tr key={index}><td>{index + 1}</td><td>{payment.date}</td></tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>
                                <div className="actions">
                                    <button className="ui button" onClick={() => setViewingBill(null)}>Tutup</button>
                                </div>
                            </div>
                        </div>
                    )}
                </React.Fragment>
            );
        }

        function KolektorDashboard({ user, onLogout, orders, onDailyPayment, consumers }) {
            const [activeItem, setActiveItem] = useState('tagihan');
            const size = useWindowSize();
            const isMobile = size.width < 768;

            const menuItems = [
                { name: 'tagihan', text: 'Daftar Tagihan', icon: 'list alternate outline' },
                { name: 'riwayat', text: 'Riwayat', icon: 'history' },
                { name: 'profil', text: 'Profil', icon: 'user' },
            ];

            const renderContent = () => {
                switch(activeItem) {
                    case 'tagihan':
                        const myActiveBills = orders && orders.filter(order =>
                            order.assignedCollectorUid === user.uid && // Filter by assignedCollectorUid
                            order.status !== 'Lunas' // Only show unsettled bills
                        );
                        return (
                            <div>
                                <h3 className="ui dividing header">Daftar Tagihan Anda</h3>
                                {myActiveBills && myActiveBills.length === 0 ? <p>Tidak ada tagihan yang ditugaskan untuk Anda.</p> : (
                                    <div className="ui cards">
                                        {myActiveBills && myActiveBills.map(bill => {
                                            // Find consumer data based on the consumerEmail stored in the order
                                            const consumerData = consumers && consumers.find(c => c.email === bill.consumerEmail);
                                            return (
                                                <div className="card" key={bill.id}>
                                                    <div className="content">
                                                        <div className="header">{bill.productName}</div>
                                                        <div className="meta">ID Pesanan: {bill.id}</div>
                                                        <div className="description">
                                                            <strong>Info Konsumen:</strong>
                                                            {/* Use full name if available, fallback to consumerName from order */}
                                                            <div>{consumerData ? consumerData.namaLengkap : bill.consumerName}</div>
                                                            <div>{consumerData ? consumerData.alamatUsaha : 'N/A'}</div>
                                                            <div>{consumerData ? consumerData.noHape : 'N/A'}</div>
                                                        </div>
                                                        <div className="description" style={{ marginTop: '1em' }}>
                                                            <strong>Info Tagihan:</strong>
                                                            <div>Angsuran: Rp {bill.installmentPrice.toLocaleString('id-ID')} / {bill.paymentFrequency === 'mingguan' ? 'minggu' : 'hari'}</div>
                                                            <div>Terbayar: {bill.payments.length} dari {bill.tenor} hari</div>
                                                            {/* Explicitly display 'Lunas' status if it's paid off */}
                                                            {bill.status === 'Lunas' && (
                                                                <div style={{marginTop: '0.5em'}}>
                                                                    <span className="ui green label"><i className="check icon"></i> Lunas</span>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                    {/* Confirm Payment button only appears if status is not 'Lunas' */}
                                                    {bill.status !== 'Lunas' ? (
                                                        <div className="ui bottom attached green button" onClick={() => onDailyPayment(bill.id)}>
                                                            <i className="check icon"></i> Konfirmasi Bayar
                                                        </div>
                                                    ) : (
                                                        <div className="ui bottom attached green button disabled">
                                                            <i className="check icon"></i> Lunas
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        );
                    case 'riwayat':
                        const myPaymentHistory = orders && orders.flatMap(order => 
                            (order.payments || [])
                                .filter(p => p.collectedBy === user.name)
                                .map(p => ({ ...p, orderId: order.id, consumerName: order.consumerName }))
                        ).reverse();
                        return (
                            <div>
                                <h3 className="ui dividing header">Riwayat Penagihan Berhasil</h3>
                                {myPaymentHistory && myPaymentHistory.length === 0 ? <p>Anda belum memiliki riwayat penagihan.</p> : (
                                    <div className="ui relaxed divided list">
                                        {myPaymentHistory && myPaymentHistory.map((payment, index) => (
                                            <div className="item" key={index}>
                                                <i className="large money bill alternate middle aligned icon"></i>
                                                <div className="content">
                                                    <div className="header">Order {payment.orderId}</div>
                                                    <div className="description">
                                                        Berhasil menagih dari <strong>{payment.consumerName}</strong> pada tanggal {payment.date}
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        );
                    case 'profil':
                        return <div><h3 className="ui dividing header">Profil Saya</h3><p>Halaman ini akan berisi informasi dan statistik performa Anda sebagai kolektor.</p></div>;
                    default: return null;
                }
            };

            const Layout = ({children}) => ( <div><div className="ui top attached menu"><div className="item"><i className="motorcycle big icon"></i><b>Kolektor Dashboard</b></div><div className="right menu"><div className="item">Hi, {user.name}!</div><div className="item"><button className="ui red button mini" onClick={onLogout}><i className="sign out icon"></i> Logout</button></div></div></div>{children}</div> );

            return (
                <Layout>
                    {isMobile ? (
                        <div className="ui attached segment mobile-content-padding">
                            {renderContent()}
                            <div className="ui bottom fixed three item icon menu">
                                {menuItems.map(item => (<a key={item.name} className={activeItem === item.name ? 'active teal item' : 'item'} onClick={() => setActiveItem(item.name)}><i className={`${item.icon} icon`}></i><span style={{fontSize:'0.8em'}}>{item.text}</span></a>))}
                            </div>
                        </div>
                    ) : (
                        <div className="ui attached segment">
                            <div className="ui grid">
                                <div className="four wide column">
                                    <div className="ui vertical fluid pointing menu">
                                        {menuItems.map(item => (<a key={item.name} className={activeItem === item.name ? 'active teal item' : 'item'} onClick={() => setActiveItem(item.name)}><i className={`${item.icon} icon`}></i> {item.text}</a>))}
                                    </div>
                                </div>
                                <div className="twelve wide stretched column"><div className="ui segment">{renderContent()}</div></div>
                            </div>
                        </div>
                    )}
                </Layout>
            );
        }

        function KonsumenDashboard({ user, onLogout, products, orders, onNewOrder, promos, onSaveProfile }) {
            // DEBUG: Log initial render state
            console.log("KonsumenDashboard Mounted/Rendered. Current profileData state (from useState):", useState(null)[0]);

            const [profileData, setProfileData] = useState(null);
            const [activeItem, setActiveItem] = useState('produk');
            const [selectedProduct, setSelectedProduct] = useState(null);
            const [selectedTenor, setSelectedTenor] = useState(60);
            const [activeImage, setActiveImage] = useState('');
            const [searchTerm, setSearchTerm] = useState('');
            const [cartItems, setCartItems] = useState([]);
            const [paymentFrequency, setPaymentFrequency] = useState('harian');
            const size = useWindowSize();
            const isMobile = size.width < 768;
            const tenorOptions = [ { days: 60, multiplier: 1.20 }, { days: 90, multiplier: 1.25 }, { days: 120, multiplier: 1.30 }, { days: 150, multiplier: 1.35 }, { days: 180, multiplier: 1.40 } ];
            
            const activeBills = orders && orders.filter(order =>
                order.consumerEmail === user.email && // Filter by logged-in consumer's email
                order.status !== 'Lunas' // Ensure order status is NOT 'Lunas'
            );
            
            // DEBUG: Log user prop changes and profileData setting
            useEffect(() => {
                console.log("KonsumenDashboard useEffect - user prop changed:", user ? user.uid : 'NO USER');
                if (user) {
                    const initialProfileData = {
                        namaLengkap: user.namaLengkap || user.email || '',
                        jenisUsaha: user.jenisUsaha || '',
                        alamatRumah: user.alamatRumah || '',
                        alamatUsaha: user.alamatUsaha || '',
                        noHape: user.noHape || '',
                        nomorKtp: user.nomorKtp || '',
                        namaSales: user.namaSales || ''
                    };
                    setProfileData(initialProfileData);
                    console.log("KonsumenDashboard useEffect - setting profileData to:", initialProfileData);
                } else {
                    setProfileData(null); // Reset profileData if user logs out
                    console.log("KonsumenDashboard useEffect - user is null, resetting profileData.");
                }
            }, [user]);

            // Separate useEffect for Semantic UI progress bar
            useEffect(() => {
                if ($('.ui.progress').length) {
                    setTimeout(() => $('.ui.progress').progress(), 50);
                }
            }, [orders]); // Depend on orders to re-run when order data changes

            // DEBUG: Log condition for ProfileForm rendering
            console.log("KonsumenDashboard: Deciding to show ProfileForm. Current profileData state for condition:", profileData);
            if (!profileData || !profileData.namaLengkap || !profileData.noHape) { 
                return <ProfileForm onSave={(data) => { setProfileData(data); onSaveProfile(data); }} user={user} />;
            }

            const handleProductClick = (product) => {
                setSelectedProduct(product);
                setSelectedTenor(60);
                setPaymentFrequency('harian');
                if (product.images && product.images.length > 0) {
                    setActiveImage(product.images[0]);
                } else {
                    setActiveImage('');
                }
            };

            const handleCloseModal = () => setSelectedProduct(null);
            
            const handleAddToCart = () => {
                const currentOption = tenorOptions.find(opt => opt.days === selectedTenor);
                if (!currentOption) { alert('Opsi tenor tidak valid.'); return; }
                const hargaHarian = (selectedProduct.hargaModal * currentOption.multiplier) / currentOption.days;
                const installmentPrice = paymentFrequency === 'mingguan' ? Math.ceil(hargaHarian) * 6 : Math.ceil(hargaHarian);

                const newItem = { 
                    product: selectedProduct, 
                    tenor: selectedTenor, 
                    paymentFrequency,
                    installmentPrice,
                    cartId: Date.now() 
                };
                setCartItems([...cartItems, newItem]);
                alert(`${selectedProduct.name} ditambahkan ke keranjang.`);
                handleCloseModal();
            };

            const handleCheckout = () => {
                if (cartItems.length === 0) return alert('Keranjang kosong!');
                const newOrders = cartItems.map(item => ({ 
                    id: `#${Date.now().toString().slice(-5) + Math.random().toString().slice(-2)}`, 
                    date: new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }), 
                    productName: item.product.name, 
                    tenor: item.tenor, 
                    installmentPrice: item.installmentPrice, 
                    paymentFrequency: item.paymentFrequency, 
                    status: 'Proses', 
                    payments: [], 
                    assignedCollector: null,
                    assignedCollectorUid: null, // Ensure this is also null
                    userId:user.uid,
                    consumerName: user.namaLengkap || user.email,
                    consumerEmail: user.email
                }));
                onNewOrder(newOrders);
                setCartItems([]);
                alert('Pesanan berhasil dibuat.');
                setActiveItem('order');
            };

            const handleRemoveFromCart = (cartId) => { setCartItems(cartItems.filter(item => item.cartId !== cartId)); };
            const filteredProducts = products && products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));
            
            const PromoCarousel = ({ promos }) => {
                const [isSlickReady, setIsSlickReady] = useState(false);
                useEffect(() => {
                    const slickCheck = setInterval(() => {
                        if (window.Slick) {
                            setIsSlickReady(true);
                            clearInterval(slickCheck);
                        }
                    }, 100);
                    return () => clearInterval(slickCheck);
                }, []);
                if (!isSlickReady || !promos || promos.length === 0) return null;

                const Slider = window.Slick;
                const settings = { dots: true, infinite: true, speed: 500, slidesToScroll: 1, autoplay: true, autoplaySpeed: 3000, slidesToShow: 1, centerMode: true, centerPadding: '20px' };
                return (
                    <div className="promo-carousel" style={{marginBottom: '2em'}}>
                        <Slider {...settings}>
                            {promos.map(promo => <div key={promo.id}><img src={promo.imageUrl} alt={`Promo ${promo.id}`} /></div>)}
                        </Slider>
                    </div>
                );
            };

            const renderStatusLabel = (status) => { const s = { 'Proses': 'yellow', 'Pengiriman': 'blue', 'Terkirim': 'green', 'Lunas': 'grey' }; const i = { 'Proses': 'sync alternate', 'Pengiriman': 'shipping fast', 'Terkirim': 'check circle', 'Lunas': 'flag checkered' }; return <span className={`ui ${s[status] || ''} label`}><i className={`${i[status] || 'info'} icon`}></i>{status}</span>; };
            
            const renderContent = () => {
                switch(activeItem) {
                    case 'produk':
                        return (
                            <div>
                                <div className="ui fluid icon input" style={{marginBottom: '1em'}}>
                                    <input type="text" placeholder="Cari produk..." value={searchTerm} onChange={(e) => setSearchTerm(e.target.value)} /><i className="search icon"></i>
                                </div>
                                <PromoCarousel promos={promos} />
                                <h2 className="ui header"><i className="shopping bag icon"></i>Etalase Produk</h2>
                                {filteredProducts && filteredProducts.length === 0 ? <p>Tidak ada produk ditemukan.</p> : (
                                    <div className={`ui ${isMobile ? 'one' : 'three'} doubling cards`}>
                                        {filteredProducts && filteredProducts.map(product => (
                                            <div className="card" key={product.id} onClick={() => handleProductClick(product)} style={{cursor: 'pointer'}}>
                                                <div className="image"><img src={product.images[0]} /></div>
                                                <div className="content">
                                                    <div className="header">{product.name}</div>
                                                    <div className="meta"><span className="ui teal label">Lihat Opsi Angsuran</span></div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        );
                    case 'keranjang':
                        return (
                            <div>
                                <h2 className="ui header"><i className="cart icon"></i>Keranjang</h2>
                                {cartItems.length === 0 ? <p>Keranjang kosong.</p> : (
                                    <div>
                                        <div className="ui relaxed divided list">
                                            {cartItems.map(item => (
                                                <div className="item" key={item.cartId}>
                                                    <div className="right floated content">
                                                        <button className="ui mini red icon button" onClick={() => handleRemoveFromCart(item.cartId)}><i className="trash icon"></i></button>
                                                    </div>
                                                    <img className="ui avatar image" src={item.product.images[0]} />
                                                    <div className="content">
                                                        <a className="header">{item.product.name}</a>
                                                        <div className="description">Tenor {item.tenor} hari @ Rp {item.installmentPrice.toLocaleString('id-ID')}/{item.paymentFrequency === 'mingguan' ? 'minggu' : 'hari'}</div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                        <button className="ui fluid primary button" onClick={handleCheckout}>Checkout</button>
                                    </div>
                                )}
                            </div>
                        );
                    case 'order':
                        const userOrders = orders.filter(order => order.userId === user?.uid);

                        return (
                            <div>
                                <h2 className="ui header"><i className="history icon"></i>Riwayat Order</h2>
                                {userOrders.length === 0 ? (
                                    <p>Belum ada pesanan.</p>
                                ) : (
                                    <div className="ui relaxed divided list">
                                        {userOrders.map(order => (
                                            <div className="item" key={order.id}>
                                                <div className="right floated content">{renderStatusLabel(order.status)}</div>
                                                <i className="large shopping cart middle aligned icon"></i>
                                                <div className="content">
                                                    <a className="header">{order.productName} ({order.id})</a>
                                                    <div className="description">{order.date}</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        );
                    case 'profile':
                        return (
                            <div>
                                <h2 className="ui header"><i className="user circle icon"></i>Profil & Tagihan</h2>
                                <div className="ui segment">
                                    <div className="ui list">
                                        <div className="item"><i className="user icon"></i><div className="content"><strong>Nama:</strong> {profileData.namaLengkap}</div></div>
                                        <div className="item"><i className="briefcase icon"></i><div className="content"><strong>Jenis Usaha:</strong> {profileData.jenisUsaha}</div></div>
                                        <div className="item"><i className="home icon"></i><div className="content"><strong>Alamat Rumah:</strong> {profileData.alamatRumah}</div></div>
                                    </div>
                                </div>
                                <h3 className="ui dividing header">Tagihan Berjalan</h3>
                                {activeBills && activeBills.length === 0 ? <p>Tidak ada tagihan aktif.</p> : activeBills.map(bill => (
                                    <div className="ui segment" key={bill.id}>
                                        <h4 className="ui header">{bill.productName} ({bill.id})</h4>
                                        {bill.assignedCollector && <p>Penagih: <strong>{bill.assignedCollector}</strong></p>}
                                        <div className="ui teal progress" data-value={bill.payments.length} data-total={bill.tenor}>
                                            <div className="bar"><div className="progress"></div></div>
                                            <div className="label">Bayar {bill.payments.length} dari {bill.tenor} hari</div>
                                        </div>
                                        <p>Angsuran: <strong>Rp {bill.installmentPrice.toLocaleString('id-ID')} / {bill.paymentFrequency === 'mingguan' ? 'minggu' : 'hari'}</strong></p>
                                        {bill.status === 'Lunas' && (
                                            <div style={{marginTop: '0.5em'}}>
                                                <span className="ui green label"><i className="check icon"></i> Lunas</span>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        );
                    default: return <div>Pilih menu</div>;
                }
            };
            
            const menuItems = [ { name: 'produk', icon: 'shopping bag', text: 'Produk' }, { name: 'order', icon: 'history', text: 'Order' }, { name: 'profile', icon: 'user circle', text: 'Profil' } ];
            
            let installmentPrice = 0;
            if (selectedProduct) {
                const currentOption = tenorOptions.find(opt => opt.days === selectedTenor);
                if (currentOption) {
                    const hargaHarian = (selectedProduct.hargaModal * currentOption.multiplier) / currentOption.days;
                    installmentPrice = paymentFrequency === 'mingguan' ? Math.ceil(hargaHarian) * 6 : Math.ceil(hargaHarian);
                }
            }

            const Layout = ({children}) => ( 
                <div>
                    <div className="ui top attached menu">
                        <div className="item"><i className="user big icon"></i><b>Halaman Konsumen</b></div>
                        <div className="right menu">
                            <a className="item" onClick={() => setActiveItem('keranjang')}>
                                <i className="cart large icon"></i>
                                {cartItems.length > 0 && <div className="ui red circular label" style={{position:'absolute', top:'5px', right:'5px'}}>{cartItems.length}</div>}
                            </a>
                            {!isMobile && profileData && <div className="item">Hi, {profileData.namaLengkap}!</div>}
                            <div className="item">
                                <button className="ui red button mini" onClick={onLogout}>
                                    <i className="sign out alternate icon"></i> Logout
                                </button>
                            </div>
                        </div>
                    </div>
                    {children}
                </div> 
            );
            
            return (
                <React.Fragment>
                    <Layout>
                        {isMobile ? (
                            <div className="ui attached segment mobile-content-padding">
                                {renderContent()}
                                <div className="ui bottom fixed three item icon menu">
                                    {menuItems.map(item => (<a key={item.name} className={activeItem === item.name ? 'active teal item' : 'item'} onClick={() => setActiveItem(item.name)}><i className={`${item.icon} icon`}></i><span style={{fontSize: '0.8em'}}>{item.text}</span></a>))}
                                </div>
                            </div>
                        ) : (
                            <div className="ui attached segment">
                                <div className="ui grid">
                                    <div className="four wide column">
                                        <div className="ui vertical fluid pointing menu">
                                            {menuItems.map(item => (<a key={item.name} className={activeItem === item.name ? 'active teal item' : 'item'} onClick={() => setActiveItem(item.name)}><i className={`${item.icon} icon`}></i> {item.text}</a>))}
                                        </div>
                                    </div>
                                    <div className="twelve wide stretched column"><div className="ui segment">{renderContent()}</div></div>
                                </div>
                            </div>
                        )}
                    </Layout>
                    
                    {selectedProduct && 
                        <div className={`ui dimmer modals page transition visible active`} style={{display: 'flex !important', zIndex: 1001}}>
                            <div className={`ui standard modal transition visible active`}>
                                <i className="close icon" onClick={handleCloseModal}></i>
                                <div className="header">{selectedProduct.name}</div>
                                <div className="scrolling content">
                                    <div className="ui stackable two column grid">
                                        <div className="column">
                                            <img className="ui large rounded image" src={activeImage} />
                                            <div className="thumbnail-gallery">
                                                {selectedProduct.images && selectedProduct.images.map((imgUrl, index) => (
                                                    <img key={index} src={imgUrl} className={`thumbnail ${imgUrl === activeImage ? 'active-thumbnail' : ''}`} onClick={() => setActiveImage(imgUrl)} />
                                                ))}
                                            </div>
                                        </div>
                                        <div className="column">
                                            <p>{selectedProduct.description}</p>
                                            <div className="ui form" style={{marginTop: '1em'}}>
                                                <div className="field">
                                                    <label>Pilih Tenor</label>
                                                    <div className="tenor-buttons-container">
                                                        {tenorOptions.map(option => (
                                                            <button key={option.days} className={`ui button ${selectedTenor === option.days ? 'primary' : ''}`} onClick={() => setSelectedTenor(option.days)}>{option.days} hari</button>
                                                        ))}
                                                    </div>
                                                </div>
                                                <div className="field">
                                                    <label>Frekuensi Pembayaran</label>
                                                    <div className="ui buttons">
                                                        <button className={`ui button ${paymentFrequency === 'harian' ? 'positive' : ''}`} onClick={() => setPaymentFrequency('harian')}>Harian</button>
                                                        <button className={`ui button ${paymentFrequency === 'mingguan' ? 'positive' : ''}`} onClick={() => setPaymentFrequency('mingguan')}>Mingguan (6 hari)</button>
                                                    </div>
                                                </div>
                                                <div className="ui large green message">
                                                    <div className="header">Angsuran Anda</div>
                                                    <p style={{fontSize: '1.5em', fontWeight: 'bold'}}>
                                                        Rp {installmentPrice.toLocaleString('id-ID')} / {paymentFrequency === 'mingguan' ? 'minggu' : 'hari'}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="actions">
                                    <button className="ui button" onClick={handleCloseModal}>Batal</button>
                                    <button className="ui primary button" onClick={handleAddToCart}><i className="cart plus icon"></i>Tambah ke Keranjang</button>
                                </div>
                            </div>
                        </div>
                    }
                </React.Fragment>
            );
        }

        //================================= KOMPONEN APP UTAMA =================================
        function App() {
            // DEBUG: Log App's user UID on every render
            console.log("App User UID:", user ? user.uid : 'NO USER');

            // --- KONEKSI KE FIREBASE ---
            const firebaseConfig = {
                apiKey: "AIzaSyCxJsjO39UnnEBzJ_OrUb_kH2InwNRDTdU",
                authDomain: "ecomercee-28797.firebaseapp.com",
                projectId: "ecomercee-28797",
                storageBucket: "ecomercee-28797.appspot.com",
                messagingSenderId: "53572493438",
                appId: "1:53572493438:web:23608b2d75f81f7e70b82f",
                measurementId: "G-HBB9YRHLBN"
            };

            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            const db = firebase.firestore();
            const auth = firebase.auth();

            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [products, setProducts] = useState([]);
            const [orders, setOrders] = useState([]);
            const [promos, setPromos] = useState([]);
            const [collectors, setCollectors] = useState([]);
            const [consumers, setConsumers] = useState([]);

            useEffect(() => {
                const unsubscribeAuth = auth.onAuthStateChanged(async (authUser) => {
                    console.log("App: onAuthStateChanged - authUser:", authUser ? authUser.uid : 'null');
                    if (authUser) {
                        const userDocRef = db.collection('users').doc(authUser.uid);
                        const userDoc = await userDocRef.get(); // Get user document from Firestore
                        console.log("App: Fetched userDoc for UID", authUser.uid, ":", userDoc.exists ? userDoc.data() : 'Does not exist');
                        if (userDoc.exists) {
                            // Set user state with data from Firestore
                            setUser({ uid: authUser.uid, email: authUser.email, ...userDoc.data() });
                            console.log("App: setUser called with:", { uid: authUser.uid, email: authUser.email, ...userDoc.data() });
                        } else {
                            auth.signOut(); // Log out if user is authenticated but not in Firestore
                        }
                    } else {
                        setUser(null); // Set user to null on logout
                        console.log("App: setUser(null) called (user logged out).");
                    }
                    setLoading(false);
                });

                const unsubscribeProducts = db.collection('products').onSnapshot(snapshot => {
                    const fetchedProducts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setProducts(fetchedProducts);
                }, error => console.error("Error fetching products: ", error));

                const unsubscribeOrders = db.collection('orders').onSnapshot(snapshot => {
                    const fetchedOrders = snapshot.docs.map(doc => ({ firebaseDocId: doc.id, ...doc.data() })); // Fetch Firebase doc ID
                    setOrders(fetchedOrders);
                }, error => console.error("Error fetching orders: ", error));

                const unsubscribePromos = db.collection('promos').onSnapshot(snapshot => {
                    const fetchedPromos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setPromos(fetchedPromos);
                }, error => console.error("Error fetching promos: ", error));

                const unsubscribeCollectors = db.collection('users').where('role', '==', 'kolektor').onSnapshot(snapshot => {
                    const fetchedCollectors = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
                    setCollectors(fetchedCollectors);
                }, error => console.error("Error fetching collectors: ", error));

                const unsubscribeConsumers = db.collection('users').where('role', '==', 'konsumen').onSnapshot(snapshot => {
                    const fetchedConsumers = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
                    setConsumers(fetchedConsumers);
                }, error => console.error("Error fetching consumers: ", error));

                return () => {
                    unsubscribeAuth();
                    unsubscribeProducts();
                    unsubscribeOrders();
                    unsubscribePromos();
                    unsubscribeCollectors();
                    unsubscribeConsumers();
                };
            }, []);


            const handleRegister = async (email, password) => {
                try {
                    const { user: authUser } = await auth.createUserWithEmailAndPassword(email, password);
                    await db.collection('users').doc(authUser.uid).set({ email: email, role: 'konsumen', name: email, namaLengkap: email });
                    alert('Registrasi berhasil!');
                } catch (error) { alert(`Registrasi Gagal: ${error.message}`); console.error("Register Error:", error); }
            };

            const handleLogin = async (email, password) => {
                try { await auth.signInWithEmailAndPassword(email, password); } catch (error) { alert(`Login Gagal: ${error.message}`); console.error("Login Error:", error); }
            };
            
            const handleLogout = () => auth.signOut();
            
            const handleAddProduct = async (productData) => {
                try {
                    await db.collection('products').add(productData);
                    alert("Produk berhasil ditambahkan!");
                } catch (error) { console.error("Error adding product: ", error); alert("Gagal menambahkan produk."); }
            };

            const handleAddPromo = async (promoData) => {
                try {
                    await db.collection('promos').add(promoData);
                    alert("Promo berhasil ditambahkan!");
                } catch (error) { console.error("Error adding promo: ", error); alert("Gagal menambahkan promo."); }
            };

            const handleUpdateOrderStatus = async (orderId, newStatus) => {
                try {
                    const orderDocQuery = db.collection('orders').where('id', '==', orderId).limit(1);
                    const snapshot = await orderDocQuery.get();

                    if (!snapshot.empty) {
                        const docId = snapshot.docs[0].id; // Get the actual Firestore document ID
                        await db.collection('orders').doc(docId).update({ status: newStatus });
                        alert("Status order berhasil diperbarui!");
                    } else {
                        alert("Order tidak ditemukan!");
                    }
                } catch (error) { console.error("Error updating order status: ", error); alert("Gagal memperbarui status order."); }
            };

            const handleAssignCollector = async (orderId, collectorName, collectorUid) => {
                try {
                    const orderDocQuery = db.collection('orders').where('id', '==', orderId).limit(1);
                    const snapshot = await orderDocQuery.get();

                    if (!snapshot.empty) {
                        const docId = snapshot.docs[0].id;
                        await db.collection('orders').doc(docId).update({ 
                            assignedCollector: collectorName, 
                            assignedCollectorUid: collectorUid // Store the UID
                        });
                        alert("Kolektor berhasil ditugaskan!");
                    } else {
                        alert("Order tidak ditemukan!");
                    }
                } catch (error) { 
                    console.error("Error assigning collector: ", error); 
                    alert("Gagal menugaskan kolektor."); 
                }
            };

            const handleNewOrder = async (newOrdersArray) => {
                try {
                    const batch = db.batch();
                    newOrdersArray.forEach(order => {
                        const docRef = db.collection('orders').doc();
                        batch.set(docRef, {
                            ...order,
                            // firebaseDocId: docRef.id, // Not strictly needed to store this if you query by 'id'
                            consumerName: user.namaLengkap || user.email,
                            consumerEmail: user.email,
                            userId: user.uid // Ensure userId is stored for consumer's orders
                        });
                    });
                    await batch.commit();
                    alert('Pesanan berhasil dibuat!');
                } catch (error) {
                    console.error("Error creating new order: ", error);
                    alert("Gagal membuat pesanan baru.");
                }
            };

            const handleDailyPayment = async (orderId) => {
                try {
                    const orderDocQuery = db.collection('orders').where('id', '==', orderId).limit(1);
                    const snapshot = await orderDocQuery.get();

                    if (!snapshot.empty) {
                        const docRef = snapshot.docs[0].ref;
                        const currentOrderData = snapshot.docs[0].data();
                        const currentPayments = currentOrderData.payments || [];
                        const tenor = parseInt(currentOrderData.tenor); 

                        console.log("--- DEBUG: handleDailyPayment ---");
                        console.log("Order ID:", orderId);
                        console.log("Status Saat Ini:", currentOrderData.status);
                        console.log("Jumlah Pembayaran Saat Ini:", currentPayments.length);
                        console.log("Tenor Order (parsed as int):", tenor);
                        console.log("---------------------------------");

                        if (currentPayments.length >= tenor) {
                            alert("Tagihan ini sudah lunas!");
                            return;
                        }

                        const newPayment = {
                            date: new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }),
                            collectedBy: user.name || user.email
                        };

                        const updatedPayments = [...currentPayments, newPayment];
                        let newStatus = currentOrderData.status;

                        if (updatedPayments.length >= tenor) {
                            newStatus = 'Lunas';
                            console.log(">>> KONDISI LUNAS TERPENUHI! Setting status ke 'Lunas'.");
                        } else {
                            console.log("Belum lunas. Pembayaran dibutuhkan lagi:", tenor - updatedPayments.length);
                        }

                        await docRef.update({
                            payments: updatedPayments,
                            status: newStatus
                        });

                        console.log("--- DEBUG: Setelah Update Firestore ---");
                        console.log("Status Baru Order di Firestore:", newStatus);
                        console.log("Jumlah Pembayaran Terbaru:", updatedPayments.length);
                        console.log("--------------------------------------");

                        alert('Pembayaran berhasil dicatat!' + (newStatus === 'Lunas' ? ' Dan tagihan sudah Lunas!' : ''));

                    } else {
                        alert("Order tidak ditemukan untuk mencatat pembayaran!");
                    }
                } catch (error) {
                    console.error("Error logging daily payment: ", error);
                    alert("Gagal mencatat pembayaran.");
                }
            };

            const handleSaveProfile = async (profileData) => {
                try {
                    await db.collection('users').doc(user.uid).update(profileData);
                    setUser(prevUser => ({ ...prevUser, ...profileData }));
                    alert('Profil berhasil diperbarui!');
                } catch (error) {
                    console.error("Error saving profile: ", error);
                    alert("Gagal menyimpan profil.");
                }
            };


            if (loading) { return <div className="ui active inverted dimmer"><div className="ui text loader">Loading...</div></div>; }

            if (!user) { return <LoginPage onLogin={handleLogin} onRegister={handleRegister} />; }
            
            switch (user.role) {
                case 'admin':
                    return (
                        <AdminDashboard
                            key={user.uid}
                            user={user}
                            onLogout={handleLogout}
                            products={products}
                            orders={orders}
                            promos={promos}
                            collectors={collectors}
                            consumers={consumers}
                            onAddProduct={handleAddProduct}
                            onAddPromo={handleAddPromo}
                            onUpdateOrderStatus={handleUpdateOrderStatus}
                            onAssignCollector={handleAssignCollector}
                        />
                    );
                case 'kolektor':
                    return (
                        <KolektorDashboard
                            key={user.uid}
                            user={user}
                            onLogout={handleLogout}
                            orders={orders}
                            consumers={consumers}
                            onDailyPayment={handleDailyPayment}
                        />
                    );
                case 'konsumen':
                    return (
                        <KonsumenDashboard
                            key={user.uid}
                            user={user}
                            onLogout={handleLogout}
                            products={products}
                            orders={orders}
                            promos={promos}
                            onNewOrder={handleNewOrder}
                            onSaveProfile={handleSaveProfile}
                        />
                    );
                default:
                    return (
                        <div>
                            <h1>Peran tidak dikenal: "{user.role}"</h1>
                            <button onClick={handleLogout}>Logout</button>
                        </div>
                    );
            }
        }

        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>